# üöÄ FLUXDESK - Guia de Deploy Automatizado

**Sistema de Chamados de TI**  
Stack: Laravel 11, Inertia.js, React, TypeScript, PostgreSQL  
Servidor: Ubuntu 24.04 LTS, Nginx, PHP-FPM 8.3, Node 20 LTS

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Pr√©-requisitos](#pr√©-requisitos)
3. [Instala√ß√£o Inicial](#instala√ß√£o-inicial)
4. [Deploy de Nova Vers√£o](#deploy-de-nova-vers√£o)
5. [Rollback](#rollback)
6. [Configura√ß√£o de Vari√°veis](#configura√ß√£o-de-vari√°veis)
7. [Estrutura de Diret√≥rios](#estrutura-de-diret√≥rios)
8. [Health Checks](#health-checks)
9. [Integra√ß√£o CI/CD](#integra√ß√£o-cicd)
10. [Troubleshooting](#troubleshooting)

---

## üéØ Vis√£o Geral

O script `install_and_deploy.sh` automatiza todo o processo de deploy do FLUXDESK em produ√ß√£o, incluindo:

- ‚úÖ Instala√ß√£o de depend√™ncias (PHP 8.3, Node 20, Nginx, PostgreSQL Client)
- ‚úÖ Configura√ß√£o de servi√ßos (Nginx, PHP-FPM, Supervisor)
- ‚úÖ Deploy com releases versionadas (rollback f√°cil)
- ‚úÖ Build de assets (Vite + React)
- ‚úÖ Migra√ß√µes de banco de dados
- ‚úÖ Otimiza√ß√£o de caches do Laravel
- ‚úÖ Health checks autom√°ticos
- ‚úÖ Rollback com um comando

### Estrutura de Releases

```
/var/www/fluxdesk/
‚îú‚îÄ‚îÄ releases/
‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-24-143000/  # Release antiga
‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-24-150000/  # Release anterior
‚îÇ   ‚îî‚îÄ‚îÄ 2025-10-24-153000/  # Release atual
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îú‚îÄ‚îÄ .env
‚îÇ   ‚îî‚îÄ‚îÄ storage/
‚îî‚îÄ‚îÄ current -> releases/2025-10-24-153000  # Symlink para release ativa
```

**Benef√≠cios:**
- Rollback instant√¢neo (troca de symlink)
- Hist√≥rico de releases (√∫ltimas 3 mantidas)
- Zero downtime em deploys bem-sucedidos

---

## üîß Pr√©-requisitos

### Servidor EC2

- **OS:** Ubuntu 24.04 LTS
- **RAM:** 2GB m√≠nimo (4GB recomendado)
- **Storage:** 20GB m√≠nimo
- **Security Group:** Portas 22 (SSH), 80 (HTTP), 443 (HTTPS)

### Banco de Dados PostgreSQL

Voc√™ pode usar:
- **Amazon RDS PostgreSQL** (recomendado)
- **PostgreSQL instalado localmente**
- **Supabase / Neon / Render** (alternativas cloud)

### Cloudflare Tunnel

O servidor j√° deve ter o Cloudflare Tunnel configurado:
```bash
sudo systemctl status cloudflared
# ‚óè cloudflared.service - cloudflared
#    Active: active (running)
```

### Acesso ao Reposit√≥rio GitHub

O reposit√≥rio √© **privado**, ent√£o voc√™ precisa configurar autentica√ß√£o:

**Op√ß√£o 1: SSH (Recomendado)**
```bash
# Gerar chave SSH
ssh-keygen -t ed25519 -C "deploy@fluxdesk"

# Exibir chave p√∫blica
cat ~/.ssh/id_ed25519.pub

# Adicionar no GitHub:
# Settings ‚Üí SSH and GPG keys ‚Üí New SSH key
```

**Op√ß√£o 2: HTTPS com Token**
```bash
# Criar Personal Access Token no GitHub
# Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Generate new token
# Permiss√µes: repo (Full control of private repositories)

# Configurar credenciais
git config --global credential.helper store
git clone https://github.com/tbmaraujo/Sistema-Chamados.git
# Usu√°rio: seu_username
# Senha: ghp_seu_token_aqui
```

---

## üöÄ Instala√ß√£o Inicial

### 1. Fazer Upload do Script

```bash
# Na sua m√°quina local
scp Setup/install_and_deploy.sh ubuntu@SEU_IP_EC2:/home/ubuntu/

# Conectar via SSH
ssh ubuntu@SEU_IP_EC2

# Dar permiss√£o de execu√ß√£o
chmod +x install_and_deploy.sh
```

### 2. Executar Instala√ß√£o Completa

```bash
sudo bash install_and_deploy.sh all
```

**O que acontece:**
1. Instala PHP 8.3 + extens√µes
2. Instala Node 20 LTS
3. Instala Nginx
4. Instala Composer 2
5. Cria estrutura de diret√≥rios (`/var/www/fluxdesk`)
6. Configura Nginx vhost
7. Configura Supervisor para queue workers
8. Clona reposit√≥rio
9. Roda `composer install --no-dev`
10. Roda `npm ci && npm run build`
11. Executa migra√ß√µes
12. Otimiza caches (config, route, view)
13. Ativa release
14. Executa health checks

### 3. Configurar Vari√°veis de Ambiente

```bash
# Editar .env compartilhado
sudo nano /var/www/fluxdesk/shared/.env
```

**Vari√°veis obrigat√≥rias:**
```env
APP_NAME=FluxDesk
APP_ENV=production
APP_KEY=base64:SER√Å_GERADO_AUTOMATICAMENTE
APP_DEBUG=false
APP_URL=https://app.fluxdesk.com.br

# Banco de dados PostgreSQL
DB_CONNECTION=pgsql
DB_HOST=seu-rds.rds.amazonaws.com  # Ou 127.0.0.1
DB_PORT=5432
DB_DATABASE=fluxdesk
DB_USERNAME=fluxdesk_user
DB_PASSWORD=sua_senha_segura_aqui

# Cache e Sess√µes
CACHE_DRIVER=file
SESSION_DRIVER=file
QUEUE_CONNECTION=sync  # Ou 'database' se usar filas
```

Ap√≥s configurar, rode novamente:
```bash
sudo bash install_and_deploy.sh deploy
```

---

## üì¶ Deploy de Nova Vers√£o

### Deploy Manual

```bash
sudo bash install_and_deploy.sh deploy
```

**Processo:**
1. Cria nova release com timestamp: `2025-10-24-153000`
2. Clona branch `main` do GitHub
3. Cria symlinks para `.env` e `storage` (shared)
4. Roda `composer install --no-dev --optimize-autoloader`
5. Roda `npm ci && npm run build` (Vite)
6. Executa `php artisan migrate --force`
7. Otimiza caches: config, route, view, event
8. Ajusta permiss√µes (`www-data`)
9. Ativa release (troca symlink `current`)
10. Reload Nginx + PHP-FPM + Cloudflared
11. Remove releases antigas (mant√©m 3)
12. Executa health checks

**Output esperado:**
```
[INFO] Iniciando deploy...
[INFO] Criando release: 2025-10-24-153000
[INFO] Clonando reposit√≥rio...
[INFO] Instalando depend√™ncias PHP...
[INFO] Compilando assets (Vite)...
[INFO] Executando migra√ß√µes...
[INFO] Otimizando caches...
[INFO] Ativando release...
[INFO] ‚úÖ Deploy conclu√≠do com sucesso!
[INFO] Release ativa: 2025-10-24-153000
[INFO] Executando health checks...
[INFO] ‚úÖ Nginx ativo
[INFO] ‚úÖ PHP-FPM ativo
[INFO] ‚úÖ Aplica√ß√£o respondendo (HTTP 200)
[INFO] ‚úÖ Sem dev-server (build de produ√ß√£o OK)
[INFO] üéâ Todos os health checks passaram!
```

---

## ‚èÆÔ∏è Rollback

Se algo der errado no deploy, fa√ßa rollback instant√¢neo:

```bash
sudo bash install_and_deploy.sh rollback
```

**O que acontece:**
1. Identifica release atual
2. Busca release anterior dispon√≠vel
3. Troca symlink `current` para release anterior
4. Reload Nginx + PHP-FPM
5. Executa health checks

**Exemplo:**
```
[INFO] Iniciando rollback...
[WARN] Fazendo rollback de 2025-10-24-153000 para 2025-10-24-150000...
[INFO] ‚úÖ Rollback conclu√≠do!
[INFO] Release ativa: 2025-10-24-150000
```

**Importante:** Rollback **n√£o reverte migra√ß√µes de banco de dados**. Se a nova release rodou migrations destrutivas, voc√™ precisar√° restaurar um backup.

---

## ‚öôÔ∏è Configura√ß√£o de Vari√°veis

### Vari√°veis do Script

Edite no in√≠cio de `install_and_deploy.sh`:

| Vari√°vel | Descri√ß√£o | Valor Padr√£o |
|----------|-----------|--------------|
| `APP_NAME` | Nome da aplica√ß√£o | `fluxdesk` |
| `DOMAIN` | Dom√≠nio da aplica√ß√£o | `app.fluxdesk.com.br` |
| `REPO_URL` | URL do reposit√≥rio GitHub | `https://github.com/tbmaraujo/Sistema-Chamados.git` |
| `BRANCH` | Branch a ser deployada | `main` |
| `PHP_VERSION` | Vers√£o do PHP | `8.3` |
| `NODE_VERSION` | Vers√£o do Node | `20` |
| `APP_DIR` | Diret√≥rio raiz | `/var/www/fluxdesk` |
| `BUILD_ON_SERVER` | Compilar assets no servidor | `true` |
| `NGINX_USER` | Usu√°rio do Nginx | `www-data` |
| `RELEASES_TO_KEEP` | N√∫mero de releases a manter | `3` |

### Vari√°veis de Ambiente (.env)

Arquivo: `/var/www/fluxdesk/shared/.env`

**Essenciais:**
```env
APP_KEY=         # Gerado automaticamente
DB_HOST=         # Host do PostgreSQL
DB_DATABASE=     # Nome do banco
DB_USERNAME=     # Usu√°rio do banco
DB_PASSWORD=     # Senha do banco
```

**Opcionais (Produ√ß√£o):**
```env
# Logging
LOG_LEVEL=error
LOG_CHANNEL=stack

# Cache (se usar Redis)
CACHE_DRIVER=redis
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

# Filas (se usar)
QUEUE_CONNECTION=database  # ou redis

# E-mail (se configurar)
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=null
MAIL_PASSWORD=null
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@fluxdesk.com.br
MAIL_FROM_NAME="${APP_NAME}"
```

---

## üìÅ Estrutura de Diret√≥rios

```
/var/www/fluxdesk/
‚îÇ
‚îú‚îÄ‚îÄ releases/                    # Todas as releases
‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-24-143000/      # Release antiga (ser√° removida)
‚îÇ   ‚îú‚îÄ‚îÄ 2025-10-24-150000/      # Release anterior
‚îÇ   ‚îî‚îÄ‚îÄ 2025-10-24-153000/      # Release atual
‚îÇ       ‚îú‚îÄ‚îÄ app/
‚îÇ       ‚îú‚îÄ‚îÄ bootstrap/
‚îÇ       ‚îú‚îÄ‚îÄ config/
‚îÇ       ‚îú‚îÄ‚îÄ database/
‚îÇ       ‚îú‚îÄ‚îÄ public/
‚îÇ       ‚îú‚îÄ‚îÄ resources/
‚îÇ       ‚îú‚îÄ‚îÄ routes/
‚îÇ       ‚îú‚îÄ‚îÄ storage -> /var/www/fluxdesk/shared/storage  # SYMLINK
‚îÇ       ‚îú‚îÄ‚îÄ .env -> /var/www/fluxdesk/shared/.env        # SYMLINK
‚îÇ       ‚îú‚îÄ‚îÄ composer.json
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îî‚îÄ‚îÄ vite.config.js
‚îÇ
‚îú‚îÄ‚îÄ shared/                      # Arquivos compartilhados
‚îÇ   ‚îú‚îÄ‚îÄ .env                     # Configura√ß√µes (n√£o versionado)
‚îÇ   ‚îî‚îÄ‚îÄ storage/                 # Storage persistente
‚îÇ       ‚îú‚îÄ‚îÄ app/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ public/          # Uploads de usu√°rios
‚îÇ       ‚îú‚îÄ‚îÄ framework/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sessions/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ views/
‚îÇ       ‚îî‚îÄ‚îÄ logs/
‚îÇ           ‚îî‚îÄ‚îÄ laravel.log
‚îÇ
‚îî‚îÄ‚îÄ current -> releases/2025-10-24-153000  # SYMLINK para release ativa
```

**Por que symlinks?**
- `.env`: Mant√©m configura√ß√µes entre deploys
- `storage`: Preserva uploads e logs
- `current`: Permite rollback instant√¢neo

---

## ü©∫ Health Checks

Execute health checks manualmente:

```bash
sudo bash install_and_deploy.sh smoke
```

**Verifica√ß√µes realizadas:**

1. **Nginx ativo**
   ```bash
   systemctl is-active nginx
   ```

2. **PHP-FPM ativo**
   ```bash
   systemctl is-active php8.3-fpm
   ```

3. **Aplica√ß√£o respondendo (HTTP 200)**
   ```bash
   curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1
   ```

4. **Sem dev-server (Vite)**
   ```bash
   curl -s http://127.0.0.1 | grep -E "5173|@vite/client" && echo "ERRO!" || echo "OK"
   ```

5. **Cloudflared ativo** (se configurado)
   ```bash
   systemctl is-active cloudflared
   ```

6. **Permiss√µes de escrita em storage**
   ```bash
   [ -w /var/www/fluxdesk/shared/storage/logs ] && echo "OK"
   ```

**Output esperado:**
```
[INFO] Executando health checks...
[INFO] ‚úÖ Nginx ativo
[INFO] ‚úÖ PHP-FPM ativo
[INFO] ‚úÖ Aplica√ß√£o respondendo (HTTP 200)
[INFO] ‚úÖ Sem dev-server (build de produ√ß√£o OK)
[INFO] ‚úÖ Cloudflared ativo
[INFO] ‚úÖ Permiss√µes OK
[INFO] üéâ Todos os health checks passaram!
```

---

## üîÑ Integra√ß√£o CI/CD

### GitHub Actions

Crie `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu
            sudo bash install_and_deploy.sh deploy

      - name: Notify on failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{"text":"‚ùå Deploy falhou!"}'
```

**Secrets necess√°rios:**
- `EC2_HOST`: IP ou dom√≠nio do servidor
- `EC2_SSH_KEY`: Chave privada SSH
- `SLACK_WEBHOOK`: (opcional) Webhook do Slack

### Deploy Manual via SSH

```bash
# Na sua m√°quina local
ssh ubuntu@SEU_IP_EC2 "cd /home/ubuntu && sudo bash install_and_deploy.sh deploy"
```

---

## üõ†Ô∏è Troubleshooting

### ‚ùå Erro: "Falha ao clonar reposit√≥rio"

**Causa:** Sem autentica√ß√£o GitHub (reposit√≥rio privado)

**Solu√ß√£o:**
```bash
# Op√ß√£o 1: SSH
ssh-keygen -t ed25519 -C "deploy@fluxdesk"
cat ~/.ssh/id_ed25519.pub
# Adicione ao GitHub: Settings ‚Üí SSH keys

# Op√ß√£o 2: Token HTTPS
git config --global credential.helper store
```

---

### ‚ùå Erro: "Falha no npm run build"

**Causa:** Mem√≥ria insuficiente (Node consome muita RAM no build)

**Solu√ß√£o:**
```bash
# Aumentar swap temporariamente
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Tentar deploy novamente
sudo bash install_and_deploy.sh deploy

# Remover swap depois
sudo swapoff /swapfile
sudo rm /swapfile
```

---

### ‚ùå Erro: "ERRO: Dev-server detectado!"

**Causa:** Build de produ√ß√£o n√£o foi executado corretamente

**Verifica√ß√£o:**
```bash
cd /var/www/fluxdesk/current
ls public/build/  # Deve conter manifest.json e assets/
```

**Solu√ß√£o:**
```bash
cd /var/www/fluxdesk/current
npm run build
sudo systemctl reload nginx
```

---

### ‚ùå Erro: "Permiss√£o negada em storage/logs"

**Causa:** Permiss√µes incorretas

**Solu√ß√£o:**
```bash
sudo chown -R www-data:www-data /var/www/fluxdesk/shared/storage
sudo chmod -R 775 /var/www/fluxdesk/shared/storage
```

---

### ‚ùå P√°gina em branco ou erro 500

**Diagn√≥stico:**
```bash
# Ver logs do Laravel
sudo tail -f /var/www/fluxdesk/shared/storage/logs/laravel.log

# Ver logs do Nginx
sudo tail -f /var/log/nginx/fluxdesk_error.log

# Ver logs do PHP-FPM
sudo tail -f /var/log/php8.3-fpm.log
```

**Causas comuns:**
- APP_KEY n√£o gerada
- Banco de dados inacess√≠vel
- Permiss√µes incorretas
- Cache corrompido

**Solu√ß√£o:**
```bash
cd /var/www/fluxdesk/current

# Limpar caches
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear

# Recriar caches
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Reload servi√ßos
sudo systemctl reload nginx
sudo systemctl reload php8.3-fpm
```

---

### ‚ùå Cloudflared n√£o conecta

**Verifica√ß√£o:**
```bash
sudo systemctl status cloudflared
sudo journalctl -u cloudflared -f
```

**Solu√ß√£o:**
```bash
sudo systemctl restart cloudflared
```

---

## üìä Monitoramento

### Logs em Tempo Real

```bash
# Laravel
sudo tail -f /var/www/fluxdesk/shared/storage/logs/laravel.log

# Nginx Access
sudo tail -f /var/log/nginx/fluxdesk_access.log

# Nginx Error
sudo tail -f /var/log/nginx/fluxdesk_error.log

# PHP-FPM
sudo tail -f /var/log/php8.3-fpm.log

# Supervisor (queue workers)
sudo tail -f /var/www/fluxdesk/shared/storage/logs/worker.log
```

### Status de Servi√ßos

```bash
# Nginx
sudo systemctl status nginx

# PHP-FPM
sudo systemctl status php8.3-fpm

# Cloudflared
sudo systemctl status cloudflared

# Supervisor
sudo supervisorctl status
```

### Espa√ßo em Disco

```bash
df -h /var/www/fluxdesk
du -sh /var/www/fluxdesk/releases/*
```

---

## üîê Seguran√ßa

### Recomenda√ß√µes

1. **Firewall (UFW):**
   ```bash
   sudo ufw allow 22/tcp   # SSH
   sudo ufw allow 80/tcp   # HTTP
   sudo ufw allow 443/tcp  # HTTPS
   sudo ufw enable
   ```

2. **Fail2Ban (prote√ß√£o SSH):**
   ```bash
   sudo apt install fail2ban
   sudo systemctl enable fail2ban
   ```

3. **Atualiza√ß√µes autom√°ticas:**
   ```bash
   sudo apt install unattended-upgrades
   sudo dpkg-reconfigure -plow unattended-upgrades
   ```

4. **SSL/TLS via Cloudflare:**
   - Cloudflare Tunnel j√° fornece SSL autom√°tico
   - Certifique-se que SSL/TLS est√° "Full" no painel Cloudflare

5. **Vari√°veis sens√≠veis:**
   - Nunca commite `.env` no Git
   - Use valores fortes em `APP_KEY` e `DB_PASSWORD`

---

## üìû Suporte

**Desenvolvedor:** Thiago Ara√∫jo  
**Reposit√≥rio:** https://github.com/tbmaraujo/Sistema-Chamados (privado)  
**Documenta√ß√£o:** `/home/thiago/Projetos/Sistema Chamados/sincro8-tickets/Setup/`

---

## üë§ Primeiro Acesso

### Criar Super Administrador

Ap√≥s o deploy inicial, crie um super administrador:

```bash
cd /var/www/fluxdesk/current

# Modo interativo (recomendado)
sudo -u www-data php artisan user:create-super-admin

# Ou com flags
sudo -u www-data php artisan user:create-super-admin \
  --email=admin@fluxdesk.com.br \
  --name="Administrador" \
  --password="SuaSenhaSegura123"
```

**O que o comando faz:**
- Cria usu√°rio com `is_super_admin = true`
- Acesso ao menu "Plataforma" (gest√£o de tenants)
- Cria tenant automaticamente se n√£o existir
- Valida email, nome e senha
- Pode atualizar usu√°rio existente

**Output esperado:**
```
üéâ Super Administrador criado com sucesso!

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  üìã CREDENCIAIS DE ACESSO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Nome:        Administrador
  Email:       admin@fluxdesk.com.br
  Fun√ß√£o:      Admin
  Super Admin: SIM
  Tenant:      FluxDesk
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üåê Acesse: https://app.fluxdesk.com.br/login
```

### Acesso ao Sistema

1. Acesse: `https://app.fluxdesk.com.br` (redireciona automaticamente para `/login`)
2. Fa√ßa login com as credenciais criadas
3. Menu "Super Admin" ‚Üí "Plataforma" estar√° vis√≠vel
4. **Importante:** Troque a senha ap√≥s primeiro login!

---

## üîí HTTPS e Proxy (Cloudflare/Nginx)

O sistema est√° configurado para funcionar corretamente atr√°s de proxies reversos (Cloudflare, Nginx, Load Balancers).

### TrustProxies Middleware

**Configurado automaticamente em `bootstrap/app.php`:**
```php
$middleware->trustProxies(at: '*');
```

**O que faz:**
- Detecta se requisi√ß√£o original era HTTPS
- Mant√©m IP real do usu√°rio (via X-Forwarded-For)
- For√ßa assets (CSS, JS) a usarem HTTPS

### ASSET_URL Autom√°tico

**O script configura automaticamente no `.env`:**
```env
ASSET_URL=https://app.fluxdesk.com.br
```

**Benef√≠cios:**
- ‚úÖ Assets sempre com HTTPS
- ‚úÖ Sem Mixed Content no navegador
- ‚úÖ Inertia.js funciona corretamente
- ‚úÖ JavaScript carrega sem bloqueios

**Verifica√ß√£o:**
```bash
# Confirmar que assets usam HTTPS
curl -s https://app.fluxdesk.com.br | grep "https://app.fluxdesk.com.br/build"
```

---

## ‚úÖ Valida√ß√µes Pr√©-Deploy

O script valida automaticamente antes de cada deploy:

### 1. PostgreSQL
```bash
[INFO] Verificando PostgreSQL...
[INFO] ‚úÖ PostgreSQL rodando
```

**Se falhar:**
- Instala PostgreSQL client se necess√°rio
- Alerta se PostgreSQL local n√£o est√° rodando
- Continua se usar RDS/remoto

### 2. Valida√ß√£o do .env
```bash
[INFO] Validando arquivo .env...
[INFO] Adicionando ASSET_URL ao .env...
[INFO] ‚úÖ .env validado
```

**Verifica:**
- ‚úÖ Arquivo `.env` existe
- ‚úÖ Vari√°veis obrigat√≥rias: `DB_HOST`, `DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD`
- ‚úÖ `ASSET_URL` configurado (adiciona se faltar)
- ‚ö†Ô∏è Alerta se `APP_DEBUG=true`

**Se faltar vari√°vel:**
```
[ERROR] Vari√°veis obrigat√≥rias faltando no .env:
  - DB_PASSWORD (senha do banco)

Configure: sudo nano /var/www/fluxdesk/shared/.env
```

### 3. Conex√£o com Banco
```bash
[INFO] Testando conex√£o com banco de dados...
[INFO] ‚úÖ Conex√£o com banco OK
```

**Verifica antes das migrations:**
- Testa conex√£o real com `php artisan db:show`
- Sugere comando para criar banco se n√£o existir
- Falha antes de clonar reposit√≥rio (economiza tempo)

**Se banco n√£o existir:**
```
[WARN] N√£o foi poss√≠vel conectar ao banco de dados
[WARN] PostgreSQL est√° rodando localmente.
[WARN] Para criar o banco automaticamente, execute:
  sudo -u postgres psql -c "CREATE DATABASE fluxdesk;"
```

---

## ‚ö†Ô∏è Importante: Cache de Rotas

**O script N√ÉO usa `route:cache` por design!**

```bash
# ‚ùå N√ÉO √© feito
php artisan route:cache

# ‚úÖ Apenas estes caches
php artisan config:cache
php artisan view:cache
php artisan event:cache
```

**Por qu√™?**
- `route:cache` n√£o suporta closures (fun√ß√µes an√¥nimas)
- Quebra rotas din√¢micas: `auth()->check()`, redirecionamentos
- Incompat√≠vel com Inertia.js
- Rota raiz (`/`) usa closure para redirecionar dinamicamente

**Se tiver problemas ap√≥s deploy:**
```bash
# Limpar cache de rotas manualmente
cd /var/www/fluxdesk/current
sudo -u www-data php artisan route:clear
```

---

## üìú Changelog

### v1.2.0 (2025-10-24)
- ‚úÖ **TrustProxies**: Suporte autom√°tico a HTTPS via proxy
- ‚úÖ **ASSET_URL**: Configura√ß√£o autom√°tica no deploy
- ‚úÖ **Valida√ß√µes pr√©-deploy**: PostgreSQL, .env, conex√£o banco
- ‚úÖ **Comando create-super-admin**: Cria√ß√£o f√°cil de super admin
- ‚úÖ **Rota raiz inteligente**: Redireciona para login/dashboard
- ‚úÖ **Sem route:cache**: Compatibilidade com Inertia.js

### v1.1.0 (2025-10-24)
- ‚úÖ SSH GitHub privado configurado automaticamente
- ‚úÖ NPM resiliente (fallback --legacy-peer-deps)
- ‚úÖ Supervisor robusto (retry + warnings claros)
- ‚úÖ Health checks aprimorados
- ‚úÖ Auto-corre√ß√£o de permiss√µes

### v1.0.0 (2025-10-24)
- ‚úÖ Script de deploy automatizado
- ‚úÖ Suporte a releases versionadas
- ‚úÖ Rollback com um comando
- ‚úÖ Health checks integrados
- ‚úÖ Build de assets no servidor
- ‚úÖ Otimiza√ß√£o de caches
- ‚úÖ Configura√ß√£o Nginx + PHP-FPM 8.3
- ‚úÖ Supervisor para queue workers
- ‚úÖ Integra√ß√£o Cloudflare Tunnel

---

**üéâ FLUXDESK est√° pronto para produ√ß√£o!**
